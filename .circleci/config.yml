# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.1
  ansible-playbook: orbss/ansible-playbook@0.0.5
  ruby: circleci/ruby@2.1.0

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/configuration-reference/#jobs
jobs:
  # execution-cloudformation:
  #   executor: aws-cli/default
  #   steps:
  #     - checkout
  #     - aws-cli/setup:
  #         aws_access_key_id: AWS_ACCESS_KEY_ID
  #         aws_secret_access_key: AWS_SECRET_ACCESS_KEY
  #         region: AWS_DEFAULT_REGION
  #     - run:
  #         name: deploy CloudFormation
  #         command: |
  #           aws cloudformation deploy \
  #             --template cloudformation/control_node.yml \
  #             --stack-name webServiceStack
  # execution-ansible:
  #   executor: ansible-playbook/default
  #   steps:
  #     - checkout
  #     - add_ssh_keys:
  #         fingerprints:
  #           - "SHA256:MfFRPirALrmTRAdw/j+bF6ghu9kvK3WI2JdrdMSSOlo"
  #     - ansible-playbook/install:
  #         version: 2.10.7
  #     - ansible-playbook/playbook:
  #         playbook: ansible/playbook.yml
  #         playbook-options: -i ansible/inventory
  execute-serverspec:
    executor: ruby/default
    steps:
      - checkout
      - ruby/install:
          version: 3.2.3
      - add_ssh_keys:
          fingerprints:
            - "SHA256:MfFRPirALrmTRAdw/j+bF6ghu9kvK3WI2JdrdMSSOlo"
      - run:
          name: Set ~/.ssh/config
          command: |
            mkdir -p ~/.ssh
            echo "Host target" >> ~/.ssh/config
            echo "HostName 52.198.173.234" >> ~/.ssh/config
            echo "User ec2-user" >> ~/.ssh/config
            echo "StrictHostKeyChecking no" >> ~/.ssh/config
      - run:
          name: Debug spec directory
          command: |
            ls -la serverspec/spec/
            ls -la serverspec/spec/target
      - run:
          name: Setup Serverspec
          command: |
            cd serverspec
            bundle install
      - run:
          name: Execute Serverspec
          command: |
            cd serverspec
            export TARGET_HOST=52.198.173.234
            bundle exec rake spec

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/configuration-reference/#workflows
workflows:
  circleci-lec00-workflow:
    jobs:
      - execute-serverspec
      # - execution-cloudformation
      # - execution-ansible:
      #     requires:
      #       - execution-cloudformation
      # - execute-serverspec:
      #     requires:
      #       - execution-ansible
